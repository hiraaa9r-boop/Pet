// MyPetCare Production Firestore Security Rules
// Last updated: 2025-01-12

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // Helper Functions
    // ==========================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }
    
    function isAdmin() {
      return isSignedIn() && 
             request.auth.token.admin == true;
    }
    
    function isPro() {
      return isSignedIn() && 
             request.auth.token.isPro == true;
    }
    
    function isProOwner(proId) {
      return isSignedIn() && request.auth.uid == proId;
    }
    
    // ==========================================
    // Users Collection
    // ==========================================
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can create their own profile on signup
      allow create: if isOwner(userId);
      
      // Users can update their own profile
      // Prevent users from self-promoting to admin
      allow update: if isOwner(userId) && 
                      (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['admin', 'role']));
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // Professionals (PRO) Collection
    // ==========================================
    match /pros/{proId} {
      // Anyone can read active PRO profiles (public listings)
      allow read: if resource.data.active == true || 
                    isOwner(proId) || 
                    isAdmin();
      
      // PRO users can create their own profile
      allow create: if isOwner(proId) && isPro();
      
      // PRO users can update their own profile
      // Only admins can change subscription status
      allow update: if (isProOwner(proId) && 
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['subscriptionStatus', 'isPro'])) ||
                      isAdmin();
      
      // Only admins can delete PRO profiles
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // Calendars Collection
    // ==========================================
    match /calendars/{proId} {
      // Anyone can read calendars to see availability
      allow read: if true;
      
      // Only PRO owner can create their calendar
      allow create: if isProOwner(proId) && isPro();
      
      // Only PRO owner can update their calendar
      allow update: if isProOwner(proId) || isAdmin();
      
      // Only admins can delete calendars
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // Bookings Collection
    // ==========================================
    match /bookings/{bookingId} {
      // Users can read their own bookings (owner or pro)
      allow read: if isSignedIn() && 
                    (resource.data.userId == request.auth.uid || 
                     resource.data.proId == request.auth.uid ||
                     isAdmin());
      
      // Signed-in users can create bookings
      allow create: if isSignedIn() && 
                      request.resource.data.userId == request.auth.uid;
      
      // Allow updates by:
      // 1. Booking owner (for cancellations)
      // 2. PRO (for status updates, no-show marking)
      // 3. Admins (full control)
      allow update: if isAdmin() || 
                      (isSignedIn() && resource.data.userId == request.auth.uid) ||
                      (isSignedIn() && resource.data.proId == request.auth.uid);
      
      // Only admins can delete bookings
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // Payments Collection
    // ==========================================
    match /payments/{paymentId} {
      // Users can read their own payment records
      allow read: if isSignedIn() && 
                    (resource.data.userId == request.auth.uid || isAdmin());
      
      // System (backend) creates payment records
      // Users cannot directly create payments
      allow create: if false;
      
      // Only admins can update payments (for refunds)
      allow update: if isAdmin();
      
      // Only admins can delete payments
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // Chats Collection (Legacy - mantenuto per compatibilit√†)
    // ==========================================
    match /chats/{chatId} {
      // Users can read chats they're members of
      allow read: if isSignedIn() && 
                    request.auth.uid in resource.data.members;
      
      // Users can create chats with themselves as a member
      allow create: if isSignedIn() && 
                      request.auth.uid in request.resource.data.members;
      
      // Members can update chat (last message, etc.)
      allow update: if isSignedIn() && 
                      request.auth.uid in resource.data.members;
      
      // Chat messages subcollection
      match /messages/{messageId} {
        // Members can read all messages in their chat
        allow read: if isSignedIn() && 
                      request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members;
        
        // Members can create messages
        allow create: if isSignedIn() && 
                        request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members &&
                        request.resource.data.senderId == request.auth.uid;
        
        // Messages cannot be updated or deleted (immutable)
        allow update, delete: if false;
      }
    }
    
    // ==========================================
    // Threads Collection (New Chat System)
    // ==========================================
    match /threads/{threadId} {
      // Users can read threads they're part of
      // threadId format: userId1_userId2 (sorted)
      allow read: if isSignedIn() && 
                    request.auth.uid in resource.data.users;
      
      // Users can create threads with themselves as a participant
      // Must ensure threadId is deterministic (sorted user IDs)
      allow create: if isSignedIn() && 
                      request.auth.uid in request.resource.data.users &&
                      request.resource.data.users.size() == 2;
      
      // Participants can update thread (last message, unread count)
      allow update: if isSignedIn() && 
                      request.auth.uid in resource.data.users;
      
      // Threads cannot be deleted by users
      allow delete: if isAdmin();
      
      // Messages subcollection
      match /messages/{messageId} {
        // Participants can read all messages in their thread
        allow read: if isSignedIn() && 
                      request.auth.uid in get(/databases/$(database)/documents/threads/$(threadId)).data.users;
        
        // Participants can create messages
        // Message 'from' field must match auth.uid
        allow create: if isSignedIn() && 
                        request.auth.uid in get(/databases/$(database)/documents/threads/$(threadId)).data.users &&
                        request.resource.data.from == request.auth.uid;
        
        // Participants can update messages (mark as read)
        allow update: if isSignedIn() && 
                        request.auth.uid in get(/databases/$(database)/documents/threads/$(threadId)).data.users;
        
        // Messages cannot be deleted (immutable chat history)
        allow delete: if false;
      }
    }
    
    // ==========================================
    // Reviews Collection
    // ==========================================
    match /reviews/{reviewId} {
      // Anyone can read reviews (public)
      allow read: if true;
      
      // Only users who completed a booking can create reviews
      // (Backend should validate booking completion)
      allow create: if isSignedIn();
      
      // Users can update their own reviews
      allow update: if isSignedIn() && 
                      resource.data.userId == request.auth.uid;
      
      // Admins can delete inappropriate reviews
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // Coupons Collection
    // ==========================================
    match /coupons/{couponCode} {
      // Anyone can read coupons to validate codes
      allow read: if true;
      
      // Only admins can create/update/delete coupons
      allow create, update, delete: if isAdmin();
    }
    
    // ==========================================
    // Audit Logs Collection
    // ==========================================
    match /audit_logs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      
      // System creates audit logs (backend)
      allow create: if false;
      
      // Audit logs are immutable
      allow update, delete: if false;
    }
    
    // ==========================================
    // Configuration Collection
    // ==========================================
    match /config/{docId} {
      // Anyone can read config (feature flags, maintenance mode)
      allow read: if true;
      
      // Only admins can update configuration
      allow create, update, delete: if isAdmin();
    }
    
    // ==========================================
    // Default Deny
    // ==========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
